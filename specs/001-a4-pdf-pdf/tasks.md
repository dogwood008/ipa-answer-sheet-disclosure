# tasks.md — A4 PDF生成（IPAテンプレート）タスク一覧 (Phase 2)

このファイルは /plan の Phase1 を受けて生成されたタスク群です。各タスクは原則 TDD（テスト先行）で実施します。

順序と依存性の方針: まず契約/自動化テストを用意し（P0）、それが失敗することを確認した上で実装を進めます。並列実行可能な独立タスクは [P] を付けます。

1. [X] (P0) 契約テスト: ブラウザ E2E スモークテストを作成する（Puppeteer）。
   - 目的: ページを開き、氏名/受験番号を入力、"PDF生成・プレビュー" をクリックして PDF が生成されることを検証。
   - 出力: `tests/e2e/generate.spec.js`（失敗する状態で追加）
   - 依存: なし

2. [X] (P0) 単体テスト: `renderTextToPngBytes` のユニットテストを作成。
   - 目的: 指定フォント名・フォントサイズで PNG バイナリが返ることを検証。
   - 出力: `tests/unit/render.spec.js`
   - 依存: なし

3. [X] (P) 実装: Google Fonts 経由で Noto Sans JP を FontFace API でロードする機能を `script.js` に追加。
   - 目的: `NOTO_CSS_URL` を fetch して CSS 内の font URL を抽出し、`FontFace` で登録・待機するロジックを実装。
   - テスト: FontFace 登録後に Canvas で同フォントが利用可能かを E2E で確認（task 1 の拡張）
   - 依存: task 1, task 2

4. (P) 実装: `script.js` に CDN フォント利用時のフォールバック改善（woff2→canvas描画→PNG embed の整合性向上）。
   - 目的: woff2 を利用して表示は行い、埋め込みはユーザ提供の ttf/otf が無い場合に PNG フォールバックする安定ロジック。
   - テスト: E2E で日本語文字が描画されることを確認。
   - 依存: task 3

5. (P) 実装: 入力バリデーションを強化（必須チェック、受験番号フォーマット、最大長の扱い）。
   - 目的: 空の必須項目で生成を防ぎ、ユーザに明確なエラーを表示する。
   - テスト: 単体/統合テストで必須項目が空の場合 PDF 生成を行わないことを検証。
   - 依存: task 1

6. (P) 実装: 長文テキストの折返し／縮小ルールを実装。
   - 目的: 指定領域に収まらない長い氏名等に対して、縮小または改行によるレンダリングを行う。
   - テスト: unit テストで複数長さのサンプルを検証。
   - 依存: task 2

7. (P) 実装: テンプレート取得の CORS エラー検出と UI 表示の改善（エラー説明と "テンプレートを手動選択" の導線を明確化）。
   - 目的: リモート取得が失敗した時のユーザ誘導を改善する。
   - テスト: E2E で fetch が 0xx/4xx/5xx の場合に適切なログ/メッセージが表示されることを検証。
   - 依存: task 1

8. (P) 実装: テンプレート毎の座標補正機能を追加（FieldMap のオフセット設定を UI で保存可能にするオプション）。
   - 目的: テンプレートの微差を補正するための簡単なオフセット設定を実装。
   - テスト: 手動検証 + 小さな統合テスト
   - 依存: none (P)

9. (P) 実装: ローカルフォント埋め込みパスの安定化（fontkit の登録手順を確実に実行する）。
   - 目的: ユーザ提供の .ttf/.otf ファイルを pdf-lib に安全に埋め込む
   - テスト: E2E で埋め込みが成功することを検証
   - 依存: task 1, task 3

10. (P) ドキュメント: `quickstart.md` を更新して E2E テスト実行手順と CI の説明を追加。
    - 出力: 更新済み `quickstart.md`
    - 依存: none (P)

11. (P) CI: GitHub Actions ワークフローを追加して E2E スモークテストを走らせる。
    - 目的: PR ごとに最小限のブラウザテストを実行
    - 出力: `.github/workflows/e2e.yml`
    - 依存: task 1

12. (P) ドキュメント: `README.md` に Noto Sans JP の利用ポリシー（CDN 表示・ローカル埋め込みの違いと注意）を追記。
    - 依存: task 3

13. (P) メンテナンス: `specs/001-a4-pdf-pdf/contracts/openapi.yaml` を 3.1.x に合わせる、または PoC 注記を追加。
    - 依存: none (P)

14. (P) 開発支援: `scripts/update-agent-context.sh` を実行してエージェントコンテキストを更新（AI アシスタント用の補助資料更新）。
    - 依存: none (P)

15. (P) 品質: ドキュメントの lint 警告（全角/半角、括弧等）を修正するタスク。
    - 依存: none (P)

16. (P) 保守: 生成された PDF のメタデータ（producer, author）に PoC 表記を追加する（印刷時のトレーサビリティ向上）。
    - 依存: none (P)


優先度: P0 が最優先（自動テスト作成）。各実装タスクは対応するテストが作成されていることを確認してから実装してください。

作業見積り: 合計で 2〜4 日（PoC の成熟度により増減）。

   ---
   生成したテスト/CI雛形:
   - `tests/e2e/generate.spec.js` (E2E スモークテスト)
   - `tests/unit/render.spec.js` (ユニットテスト)
   - `package.json` (テスト用スクリプトと devDependencies)
   - `.github/workflows/e2e.yml` (E2E ワークフロー雛形)
